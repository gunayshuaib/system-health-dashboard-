name: CI/CD
uses: actions/checkout@v4


- name: Set up Python
uses: actions/setup-python@v4
with:
python-version: '3.11'


- name: Install dependencies
run: |
python -m pip install --upgrade pip
pip install -r requirements.txt


- name: Run tests
run: |
# add your test command here; placeholder passes by default
echo "No tests defined"


- name: Log in to registry
uses: docker/login-action@v2
with:
registry: ghcr.io
username: ${{ github.actor }}
password: ${{ secrets.GITHUB_TOKEN }}


- name: Build and push image
uses: docker/build-push-action@v4
with:
context: .
push: true
tags: ghcr.io/${{ github.repository_owner }}/${{ github.repository }}:latest


deploy-helm:
needs: build-and-push
runs-on: ubuntu-latest
if: github.ref == 'refs/heads/main'


steps:
- name: Checkout
uses: actions/checkout@v4


- name: Setup kubectl
uses: azure/setup-kubectl@v3
with:
version: 'latest'


- name: Setup Helm
uses: azure/setup-helm@v3
with:
version: 'latest'


- name: Configure Kubeconfig
env:
KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
run: |
echo "$KUBECONFIG_DATA" | base64 --decode > kubeconfig
export KUBECONFIG=$PWD/kubeconfig


- name: Deploy with Helm
env:
KUBECONFIG: ${{ github.workspace }}/kubeconfig
run: |
helm repo update || true
helm upgrade --install system-health-dashboard charts/system-health-dashboard \
--set image.repository=g